# 要件定義書

## はじめに

argparse-coreは、PythonのargparseモジュールのコアAPIをC++で実装するヘッダオンリーライブラリです。Python開発者が慣れ親しんだAPIを提供することで、C++でのコマンドライン引数解析を直感的かつ効率的に行えるようにします。本仕様は、基本的な引数解析機能の実装に焦点を当て、ArgumentParserクラス、位置引数、オプション引数、ヘルプ生成などの中核機能を定義します。

## プロダクトビジョンとの整合性

この機能は、ステアリング文書で定義された以下の目標を直接サポートします：

- **Python argparse API互換性**: Pythonユーザーが学習コストゼロで使用開始できる
- **ヘッダオンリー設計**: 単一ファイルインクルードで即座に使用可能
- **型安全な解析**: C++の型システムを活用した安全な実装
- **段階的開示**: 基本機能から始めて、必要に応じて高度な機能を使用可能

## 要件

### 要件1: ArgumentParserクラスの基本実装

**ユーザーストーリー:** C++開発者として、Pythonのargparseと同じAPIでパーサーを初期化したい。それにより、既存の知識を活用してCLIツールを構築できる。

#### 受け入れ基準

1. WHEN プログラム名を指定してArgumentParserを作成 THEN システムは 有効なパーサーインスタンスを生成する
2. WHEN descriptionパラメータを指定 THEN システムは ヘルプメッセージにその説明を含める
3. WHEN prog引数を省略 THEN システムは argv[0]から自動的にプログラム名を取得する
4. IF epilogパラメータを指定 THEN システムは ヘルプメッセージの最後にその文章を追加する

### 要件2: 位置引数のサポート

**ユーザーストーリー:** CLIツール開発者として、必須の位置引数を定義したい。それにより、ユーザーがファイル名やコマンドなどを指定できる。

#### 受け入れ基準

1. WHEN add_argument()で位置引数を追加 THEN システムは その引数を必須として扱う
2. WHEN nargsで引数の数を指定 THEN システムは 指定された数の値を受け取る
3. WHEN 位置引数が不足 THEN システムは エラーメッセージを表示して終了する
4. IF helpパラメータを指定 THEN システムは ヘルプメッセージにその説明を表示する

### 要件3: オプション引数のサポート

**ユーザーストーリー:** CLIツール開発者として、オプショナルな引数を定義したい。それにより、ユーザーが追加の設定や動作を指定できる。

#### 受け入れ基準

1. WHEN "--"または"-"で始まる引数を追加 THEN システムは それをオプション引数として扱う
2. WHEN actionパラメータで"store_true"を指定 THEN システムは フラグとして動作する
3. WHEN defaultパラメータを指定 THEN システムは 引数が指定されない場合にその値を使用する
4. WHEN typeパラメータを指定 THEN システムは 入力値を指定された型に変換する
5. IF 短縮形と長形式を両方指定 THEN システムは どちらでも受け付ける

### 要件4: parse_args()メソッドの実装

**ユーザーストーリー:** アプリケーション開発者として、コマンドライン引数を解析したい。それにより、解析結果を構造化されたデータとして扱える。

#### 受け入れ基準

1. WHEN parse_args()を呼び出す THEN システムは argcとargvから引数を解析する
2. WHEN 文字列ベクターを渡す THEN システムは その内容を解析する
3. WHEN 解析が成功 THEN システムは Namespaceオブジェクトを返す
4. IF 不正な引数が渡される THEN システムは エラーメッセージを表示して例外を投げる

### 要件5: 自動ヘルプ生成

**ユーザーストーリー:** エンドユーザーとして、--helpオプションでツールの使い方を確認したい。それにより、ツールを正しく使用できる。

#### 受け入れ基準

1. WHEN --helpまたは-hが指定される THEN システムは ヘルプメッセージを表示して終了する
2. WHEN add_help=falseを指定 THEN システムは 自動ヘルプを無効化する
3. WHEN ヘルプが表示される THEN システムは 全ての引数とその説明を含める
4. IF usage文字列が指定される THEN システムは デフォルトの代わりにそれを使用する

### 要件6: 型変換と検証

**ユーザーストーリー:** ライブラリ利用者として、引数値を適切な型に自動変換したい。それにより、型安全なコードを書ける。

#### 受け入れ基準

1. WHEN typeでintを指定 THEN システムは 文字列を整数に変換する
2. WHEN typeでfloatを指定 THEN システムは 文字列を浮動小数点数に変換する
3. WHEN choicesパラメータを指定 THEN システムは 指定された値のみ受け付ける
4. IF 変換に失敗 THEN システムは 適切なエラーメッセージを表示する

### 要件7: 引数グループ

**ユーザーストーリー:** CLI設計者として、関連する引数をグループ化したい。それにより、ヘルプメッセージが整理される。

#### 受け入れ基準

1. WHEN add_argument_group()を呼び出す THEN システムは 新しいグループを作成する
2. WHEN グループに引数を追加 THEN システムは ヘルプでグループごとに表示する
3. WHEN グループにタイトルを指定 THEN システムは ヘルプにそのタイトルを表示する
4. IF descriptionを指定 THEN システムは グループの説明を表示する

## 非機能要件

### コードアーキテクチャとモジュール性
- **単一責任原則**: 各クラスは明確に定義された単一の目的を持つ
- **モジュラー設計**: 引数解析、ヘルプ生成、値変換は独立したコンポーネント
- **依存関係管理**: 標準ライブラリのみに依存、外部依存なし
- **明確なインターフェース**: Python argparseと互換性のある公開API

### パフォーマンス
- 引数100個の解析を1ms未満で完了
- メモリ使用量は引数数に対してO(n)
- テンプレート実体化によるコンパイル時最適化

### セキュリティ
- バッファオーバーフローの防止（std::string使用）
- 悪意のある入力に対する堅牢性
- メモリリークの防止（RAII原則）

### 信頼性
- 強い例外安全性保証
- 明確で実用的なエラーメッセージ
- 予期しない入力に対する適切な処理

### 使いやすさ
- Python argparseと同一のAPIシグネチャ
- 5分以内に最初の例を動作可能
- 包括的なエラーメッセージとヘルプテキスト
- インテリセンス対応の型定義